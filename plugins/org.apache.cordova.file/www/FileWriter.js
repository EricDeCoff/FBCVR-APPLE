var exec=require("cordova/exec"),FileError=require("./FileError"),ProgressEvent=require("./ProgressEvent"),FileWriter=function(e){this.fileName="",this.length=0,e&&(this.localURL=e.localURL||e,this.length=e.size||0),this.position=0,this.readyState=0,this.result=null,this.error=null,this.onwritestart=null,this.onprogress=null,this.onwrite=null,this.onwriteend=null,this.onabort=null,this.onerror=null};FileWriter.INIT=0,FileWriter.WRITING=1,FileWriter.DONE=2,FileWriter.prototype.abort=function(){if(this.readyState===FileWriter.DONE||this.readyState===FileWriter.INIT)throw new FileError(FileError.INVALID_STATE_ERR);this.error=new FileError(FileError.ABORT_ERR),this.readyState=FileWriter.DONE,"function"==typeof this.onabort&&this.onabort(new ProgressEvent("abort",{target:this})),"function"==typeof this.onwriteend&&this.onwriteend(new ProgressEvent("writeend",{target:this}))},FileWriter.prototype.write=function(e){var r,t=this,i="undefined"!=typeof window.Blob&&"undefined"!=typeof window.ArrayBuffer,n="windows8"===cordova.platformId||"windows"===cordova.platformId;if(e instanceof File||!n&&i&&e instanceof Blob){var o=new FileReader;return o.onload=function(){FileWriter.prototype.write.call(t,this.result)},void(i?o.readAsArrayBuffer(e):o.readAsText(e))}if(r=i&&e instanceof ArrayBuffer,r&&"windowsphone"===cordova.platformId&&(e=Array.apply(null,new Uint8Array(e))),this.readyState===FileWriter.WRITING)throw new FileError(FileError.INVALID_STATE_ERR);this.readyState=FileWriter.WRITING;var s=this;"function"==typeof s.onwritestart&&s.onwritestart(new ProgressEvent("writestart",{target:s})),exec(function(e){s.readyState!==FileWriter.DONE&&(s.position+=e,s.length=s.position,s.readyState=FileWriter.DONE,"function"==typeof s.onwrite&&s.onwrite(new ProgressEvent("write",{target:s})),"function"==typeof s.onwriteend&&s.onwriteend(new ProgressEvent("writeend",{target:s})))},function(e){s.readyState!==FileWriter.DONE&&(s.readyState=FileWriter.DONE,s.error=new FileError(e),"function"==typeof s.onerror&&s.onerror(new ProgressEvent("error",{target:s})),"function"==typeof s.onwriteend&&s.onwriteend(new ProgressEvent("writeend",{target:s})))},"File","write",[this.localURL,e,this.position,r])},FileWriter.prototype.seek=function(e){if(this.readyState===FileWriter.WRITING)throw new FileError(FileError.INVALID_STATE_ERR);(e||0===e)&&(this.position=0>e?Math.max(e+this.length,0):e>this.length?this.length:e)},FileWriter.prototype.truncate=function(e){if(this.readyState===FileWriter.WRITING)throw new FileError(FileError.INVALID_STATE_ERR);this.readyState=FileWriter.WRITING;var r=this;"function"==typeof r.onwritestart&&r.onwritestart(new ProgressEvent("writestart",{target:this})),exec(function(e){r.readyState!==FileWriter.DONE&&(r.readyState=FileWriter.DONE,r.length=e,r.position=Math.min(r.position,e),"function"==typeof r.onwrite&&r.onwrite(new ProgressEvent("write",{target:r})),"function"==typeof r.onwriteend&&r.onwriteend(new ProgressEvent("writeend",{target:r})))},function(e){r.readyState!==FileWriter.DONE&&(r.readyState=FileWriter.DONE,r.error=new FileError(e),"function"==typeof r.onerror&&r.onerror(new ProgressEvent("error",{target:r})),"function"==typeof r.onwriteend&&r.onwriteend(new ProgressEvent("writeend",{target:r})))},"File","truncate",[this.localURL,e])},module.exports=FileWriter;