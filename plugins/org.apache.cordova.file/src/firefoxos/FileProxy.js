var LocalFileSystem=require("./LocalFileSystem"),FileSystem=require("./FileSystem"),FileEntry=require("./FileEntry"),FileError=require("./FileError"),DirectoryEntry=require("./DirectoryEntry"),File=require("./File");!function(e,t){function r(e){var t=new Blob;this.size=e.size||0,this.name=e.name||"",this.type=e.type||"",this.lastModifiedDate=e.lastModifiedDate||null,this.storagePath=e.storagePath||"",Object.defineProperty(this,"blob_",{enumerable:!0,get:function(){return t},set:function(e){t=e,this.size=t.size,this.name=t.name,this.type=t.type,this.lastModifiedDate=t.lastModifiedDate}.bind(this)})}function i(e,t){t=t||"";var r=t,i="";e=e||u,0===e.indexOf(FILESYSTEM_PREFIX)&&(i=e.substring(0,e.indexOf(u,FILESYSTEM_PREFIX.length)),e=e.substring(e.indexOf(u,FILESYSTEM_PREFIX.length)));var n=t[0]!==u;n&&(r=e,r+=e!=u?u+t:t);for(var o=r.split(u),a=0;a<o.length;++a){var l=o[a];".."==l&&(o[a-1]="",o[a]="")}return r=o.filter(function(e){return e}).join(u),r[0]!==u&&(r=u+r),r=r.replace(/\.\//g,u),r=r.replace(/\/\//g,u),r=r.replace(/\/\./g,u),r[r.length-1]==u&&r!=u&&(r=r.substring(0,r.length-1)),{storagePath:i+r,fullPath:r,fileName:r.split(u).pop(),fsName:i.split(u).pop()}}function n(e){var t=new FileEntry(e.name,e.fullPath,e.fileSystem);return t.file_=e.file_,t}function o(t,r,i,n,o,a,l){e.getFile(function(e){var r=new FileReader,s=e.file_.blob_.slice(n,o);switch(r.onload=function(e){a(e.target.result)},r.onerror=l,t){case"text":r.readAsText(s,i);break;case"dataURL":r.readAsDataURL(s);break;case"arrayBuffer":r.readAsArrayBuffer(s);break;case"binaryString":r.readAsBinaryString(s)}},l,[r,null])}function a(e){switch(e.target.errorCode){case 12:console.log("Error - Attempt to open db with a lower version than the current one.");break;default:console.log("errorCode: "+e.target.errorCode)}console.log(e,e.code,e.message)}var l=t.indexedDB||t.mozIndexedDB;if(!l)throw"Firefox OS File plugin: indexedDB not supported";var s=null,c={};c.db=null;var f="entries",u="/",d=String.fromCharCode(u.charCodeAt(0)+1),y={applicationDirectory:location.origin+"/",dataDirectory:"file:///persistent/",cacheDirectory:"file:///temporary/"};e.requestFileSystem=function(e,t,r){{var i=r[0];r[1]}if(i!==LocalFileSystem.TEMPORARY&&i!==LocalFileSystem.PERSISTENT)return void(t&&t(FileError.INVALID_MODIFICATION_ERR));var n=i===LocalFileSystem.TEMPORARY?"temporary":"persistent",o=(location.protocol+location.host).replace(/:/g,"_"),a=new DirectoryEntry("",u);s=new FileSystem(n,a),c.open(o,function(){e(s)},t)},require("./fileSystems").getFs=function(e,t){t(new FileSystem(e,s.root))},e.readEntries=function(e,t,r){var n=r[0];if(!e)throw Error("Expected successCallback argument.");var o=i(n);c.getAllEntries(o.fullPath,o.storagePath,function(t){e(t)},t)},e.getFile=function(e,t,o){var a=o[0],l=o[1],f=o[2]||{};l=i(a,l),c.get(l.storagePath,function(i){if(f.create===!0&&f.exclusive===!0&&i)t&&t(FileError.PATH_EXISTS_ERR);else if(f.create!==!0||i)f.create===!0&&i?i.isFile?c["delete"](l.storagePath,function(){var i=new FileEntry(l.fileName,l.fullPath,new FileSystem(l.fsName,s.root));i.file_=new r({size:0,name:i.name,lastModifiedDate:new Date,storagePath:l.storagePath}),c.put(i,l.storagePath,e,t)},t):t&&t(FileError.INVALID_MODIFICATION_ERR):f.create&&f.create!==!1||i?f.create&&f.create!==!1||!i||!i.isDirectory?e(n(i)):t&&t(FileError.INVALID_MODIFICATION_ERR):t&&t(FileError.NOT_FOUND_ERR);else{var o=new FileEntry(l.fileName,l.fullPath,new FileSystem(l.fsName,s.root));o.file_=new r({size:0,name:o.name,lastModifiedDate:new Date,storagePath:l.storagePath}),c.put(o,l.storagePath,e,t)}},t)},e.getFileMetadata=function(t,r,i){var n=i[0];e.getFile(function(e){t(new File(e.file_.name,e.fullPath,"",e.file_.lastModifiedDate,e.file_.size))},r,[n,null])},e.getMetadata=function(t,r,i){e.getFile(function(e){t({modificationTime:e.file_.lastModifiedDate,size:e.file_.lastModifiedDate})},r,i)},e.setMetadata=function(t,r,i){var n=i[0],o=i[1];e.getFile(function(e){e.file_.lastModifiedDate=o.modificationTime},r,[n,null])},e.write=function(t,r,i){{var n=i[0],o=i[1],a=i[2];i[3]}return o?void e.getFile(function(e){var i=e.file_.blob_;if(i){var n=i.slice(0,a),l=i.slice(a+o.byteLength),s=a-n.size;0>s&&(s=0),i=new Blob([n,new Uint8Array(s),o,l],{type:o.type})}else i=new Blob([o],{type:o.type});e.file_.blob_=i,e.file_.lastModifiedDate=o.lastModifiedDate||null,e.file_.size=i.size,e.file_.name=i.name,e.file_.type=i.type,c.put(e,e.file_.storagePath,function(){t(o.byteLength)},r)},r,[n,null]):void(r&&r(FileError.INVALID_MODIFICATION_ERR))},e.readAsText=function(e,t,r){var i=r[0],n=r[1],a=r[2],l=r[3];o("text",i,n,a,l,e,t)},e.readAsDataURL=function(e,t,r){var i=r[0],n=r[1],a=r[2];o("dataURL",i,null,n,a,e,t)},e.readAsBinaryString=function(e,t,r){var i=r[0],n=r[1],a=r[2];o("binaryString",i,null,n,a,e,t)},e.readAsArrayBuffer=function(e,t,r){var i=r[0],n=r[1],a=r[2];o("arrayBuffer",i,null,n,a,e,t)},e.removeRecursively=e.remove=function(e,t,r){var i=r[0];c["delete"](i,function(){e()},t)},e.getDirectory=function(e,t,r){var n=r[0],o=r[1],a=r[2];o=i(n,o),c.get(o.storagePath,function(r){if(a||(a={}),a.create===!0&&a.exclusive===!0&&r)t&&t(FileError.INVALID_MODIFICATION_ERR);else if(a.create!==!0||r)if(a.create===!0&&r)r.isDirectory?e(new DirectoryEntry(r.name,r.fullPath,r.fileSystem)):t&&t(FileError.INVALID_MODIFICATION_ERR);else if(a.create&&a.create!==!1||r)a.create&&a.create!==!1||!r||!r.isFile?e(new DirectoryEntry(r.name,r.fullPath,r.fileSystem)):t&&t(FileError.INVALID_MODIFICATION_ERR);else{if(o.fullPath===u)return void e(s.root);t&&t(FileError.NOT_FOUND_ERR)}else{var i=new DirectoryEntry(o.fileName,o.fullPath,new FileSystem(o.fsName,s.root));c.put(i,o.storagePath,e,t)}},t)},e.getParent=function(t,r,i){var n=i[0];if(n===u)return void t(s.root);var o=n.split(u);o.pop();var a=o.pop(),l=o.join(u);e.getDirectory(t,r,[l,a,{create:!1}])},e.copyTo=function(t,r,i){var n=i[0],o=i[1],a=i[2];e.getFile(function(i){e.getFile(function(n){e.write(function(){t(n)},r,[n.file_.storagePath,i.file_.blob_,0])},r,[o,a,{create:!0}])},r,[n,null])},e.moveTo=function(t,r,i){{var n=i[0];i[1],i[2]}e.copyTo(function(i){e.remove(function(){t(i)},r,[n])},r,i)},e.resolveLocalFileSystemURI=function(t,r,i){function n(e){e.createWriter(function(i){i.onwriteend=function(r){r.target.error||(e.filesystemName=location.hostname,t(e))},i.onerror=function(){r&&r(FileError.NOT_READABLE_ERR)},i.write(new Blob([a.response]))},r)}var o=i[0];if(-1!==o.indexOf("?")&&(o=String(o).split("?")[0]),/\%5/g.test(o)&&(o=decodeURI(o)),0===o.indexOf(y.dataDirectory))o=o.substring(y.dataDirectory.length-1),e.requestFileSystem(function(e){e.root.getFile(o,{create:!1},t,function(){e.root.getDirectory(o,{create:!1},t,r)})},r,[LocalFileSystem.PERSISTENT]);else if(0===o.indexOf(y.cacheDirectory))o=o.substring(y.cacheDirectory.length-1),e.requestFileSystem(function(e){e.root.getFile(o,{create:!1},t,function(){e.root.getDirectory(o,{create:!1},t,r)})},r,[LocalFileSystem.TEMPORARY]);else if(0===o.indexOf(y.applicationDirectory)){o=o.substring(y.applicationDirectory.length);var a=new XMLHttpRequest;a.open("GET",o,!0),a.onreadystatechange=function(){200===a.status&&4===a.readyState&&e.requestFileSystem(function(e){e.name=location.hostname,e.root.getFile(o,{create:!0},n,r)},r,[LocalFileSystem.PERSISTENT])},a.onerror=function(){r&&r(FileError.NOT_READABLE_ERR)},a.send()}else r&&r(FileError.NOT_FOUND_ERR)},e.requestAllPaths=function(e){e(y)},r.prototype.constructor=r,c.open=function(e,t,r){var i=this,n=l.open(e.replace(":","_"));n.onerror=r||a,n.onupgradeneeded=function(e){if(i.db=e.target.result,i.db.onerror=a,!i.db.objectStoreNames.contains(f)){i.db.createObjectStore(f)}},n.onsuccess=function(e){i.db=e.target.result,i.db.onerror=a,t(e)},n.onblocked=r||a},c.close=function(){this.db.close(),this.db=null},c.get=function(e,t,r){if(!this.db)return void(r&&r(FileError.INVALID_MODIFICATION_ERR));var i=this.db.transaction([f],"readonly"),n=IDBKeyRange.bound(e,e+d,!1,!0),o=i.objectStore(f).get(n);i.onabort=r||a,i.oncomplete=function(){t(o.result)}},c.getAllEntries=function(e,t,r,i){if(!this.db)return void(i&&i(FileError.INVALID_MODIFICATION_ERR));var o=[];t[t.length-1]===u&&(t=t.substring(0,t.length-1)),range=IDBKeyRange.bound(t+u,t+d,!1,!0);var l=this.db.transaction([f],"readonly");l.onabort=i||a,l.oncomplete=function(){o=o.filter(function(t){var r=t.fullPath.split(u).length,i=e.split(u).length;return e===u&&i+1>r?t:e!==u&&r===i+1?t:void 0}),r(o)};var s=l.objectStore(f).openCursor(range);s.onsuccess=function(e){var t=e.target.result;if(t){var r=t.value;o.push(r.isFile?n(r):new DirectoryEntry(r.name,r.fullPath,r.fileSystem)),t["continue"]()}}},c["delete"]=function(e,t,r){if(!this.db)return void(r&&r(FileError.INVALID_MODIFICATION_ERR));var i=this.db.transaction([f],"readwrite");i.oncomplete=t,i.onabort=r||a;var n=IDBKeyRange.bound(e,e+d,!1,!0);i.objectStore(f)["delete"](n)},c.put=function(e,t,r,i){if(!this.db)return void(i&&i(FileError.INVALID_MODIFICATION_ERR));var n=this.db.transaction([f],"readwrite");n.onabort=i||a,n.oncomplete=function(){r(e)},n.objectStore(f).put(e,t)}}(module.exports,window),require("cordova/exec/proxy").add("File",module.exports);