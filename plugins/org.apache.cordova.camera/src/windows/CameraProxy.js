var cordova=require("cordova"),Camera=require("./Camera");module.exports={takePicture:function(e,o,n){var a=n[5],t=n[3],i=n[4],r=n[2],c=n[1],s=n[6],d=!!n[7],p=n[9],l=n[11],u=function(n){var r="";r=a==Camera.EncodingType.PNG?"camera_cordova_temp_return.png":"camera_cordova_temp_return.jpg";var c=Windows.Storage.ApplicationData.current.localFolder;n.copyAsync(c,n.name,Windows.Storage.NameCollisionOption.replaceExisting).then(function(a){Windows.Storage.FileIO.readBufferAsync(a).then(function(a){var c=Windows.Security.Cryptography.CryptographicBuffer.encodeToBase64String(a),s="data:"+n.contentType+";base64,"+c,d=new Image;d.src=s,d.onload=function(){var a=t,c=i,s=document.createElement("canvas");s.width=a,s.height=c,s.getContext("2d").drawImage(this,0,0,a,c);var d=s.toDataURL(n.contentType).split(",")[1],p=Windows.Storage.ApplicationData.current.localFolder;p.createFileAsync(r,Windows.Storage.CreationCollisionOption.generateUniqueName).done(function(n){var a=Windows.Security.Cryptography.CryptographicBuffer.decodeFromBase64String(d);Windows.Storage.FileIO.writeBufferAsync(n,a).then(function(){e("ms-appdata:///local/"+n.name)},function(){o("Resize picture error.")})})}})},function(){o("Can't access localStorage folder")})},g=function(o){Windows.Storage.FileIO.readBufferAsync(o).done(function(n){var a=Windows.Security.Cryptography.CryptographicBuffer.encodeToBase64String(n),r="data:"+o.contentType+";base64,"+a,c=new Image;c.src=r,c.onload=function(){var n=t,a=i,r=document.createElement("canvas");r.width=n,r.height=a;var c=r.getContext("2d");c.drawImage(this,0,0,n,a);var s=r.toDataURL(o.contentType),d=s.split(","),p=s.substr(d[0].length+1);e(p)}})};if(r!=Camera.PictureSourceType.CAMERA){if(navigator.appVersion.indexOf("Windows Phone 8.1")>=0)return void o("Not supported");var f=new Windows.Storage.Pickers.FileOpenPicker;f.suggestedStartLocation=Windows.Storage.Pickers.PickerLocationId.picturesLibrary,f.fileTypeFilter.replaceAll(s==Camera.MediaType.PICTURE?[".png",".jpg",".jpeg"]:s==Camera.MediaType.VIDEO?[".avi",".flv",".asx",".asf",".mov",".mp4",".mpg",".rm",".srt",".swf",".wmv",".vob"]:["*"]),f.pickSingleFileAsync().done(function(n){if(n)if(c==Camera.DestinationType.FILE_URI||c==Camera.DestinationType.NATIVE_URI)if(i>0&&t>0)u(n);else{var a=Windows.Storage.ApplicationData.current.localFolder;n.copyAsync(a,n.name,Windows.Storage.NameCollisionOption.replaceExisting).then(function(o){e(URL.createObjectURL(o))},function(){o("Can't access localStorage folder.")})}else i>0&&t>0?g(n):Windows.Storage.FileIO.readBufferAsync(n).done(function(o){var n=Windows.Security.Cryptography.CryptographicBuffer.encodeToBase64String(o);e(n)});else o("User didn't choose a file.")},function(){o("User didn't choose a file.")})}else{var m=Windows.Media.Capture;if(m.CameraCaptureUI){var C=new Windows.Media.Capture.CameraCaptureUI;C.photoSettings.allowCropping=d,C.photoSettings.format=a==Camera.EncodingType.PNG?Windows.Media.Capture.CameraCaptureUIPhotoFormat.png:Windows.Media.Capture.CameraCaptureUIPhotoFormat.jpeg,C.photoSettings.maxResolution=t>=1280||i>=960?Windows.Media.Capture.CameraCaptureUIMaxPhotoResolution.large3M:t>=1024||i>=768?Windows.Media.Capture.CameraCaptureUIMaxPhotoResolution.mediumXga:t>=800||i>=600?Windows.Media.Capture.CameraCaptureUIMaxPhotoResolution.mediumXga:t>=640||i>=480?Windows.Media.Capture.CameraCaptureUIMaxPhotoResolution.smallVga:t>=320||i>=240?Windows.Media.Capture.CameraCaptureUIMaxPhotoResolution.verySmallQvga:Windows.Media.Capture.CameraCaptureUIMaxPhotoResolution.highestAvailable,C.captureFileAsync(Windows.Media.Capture.CameraCaptureUIMode.photo).then(function(n){if(n){var a=function(){if(c==Camera.DestinationType.FILE_URI)if(i>0&&t>0)u(n);else{var a=Windows.Storage.ApplicationData.current.localFolder;n.copyAsync(a,n.name,Windows.Storage.NameCollisionOption.replaceExisting).then(function(o){e("ms-appdata:///local/"+o.name)},function(){o("Can't access localStorage folder.")})}else i>0&&t>0?g(n):Windows.Storage.FileIO.readBufferAsync(n).done(function(o){var n=Windows.Security.Cryptography.CryptographicBuffer.encodeToBase64String(o);e(n)})},r=function(){o("Save fail.")};p?Windows.Storage.StorageFile.getFileFromPathAsync(n.path).then(function(e){e.copyAsync(Windows.Storage.KnownFolders.picturesLibrary,n.name,Windows.Storage.NameCollisionOption.generateUniqueName).then(function(){a()},function(){r()})}):a()}else o("User didn't capture a photo.")},function(){o("Fail to capture a photo.")})}else{var y=null,w=null,h=null,v=null,S=function(){y=document.createElement("video"),y.style.cssText="position: fixed; left: 0; top: 0; width: 100%; height: 100%; z-order: 999",w=document.createElement("button"),w.innerText="Cancel",w.style.cssText="position: fixed; right: 0; bottom: 0; display: block; margin: 20px; z-order: 1000",h=new m.MediaCapture,v=new m.MediaCaptureInitializationSettings,v.streamingCaptureMode=m.StreamingCaptureMode.video},W=function(){var e=1===l?Windows.Devices.Enumeration.Panel.front:Windows.Devices.Enumeration.Panel.back;Windows.Devices.Enumeration.DeviceInformation.findAllAsync(Windows.Devices.Enumeration.DeviceClass.videoCapture).done(function(n){n.length>0?(n.forEach(function(o){o.enclosureLocation.panel&&o.enclosureLocation.panel==e&&(v.videoDeviceId=o.id)}),h.initializeAsync(v).done(function(){h.setPreviewRotation(Windows.Media.Capture.VideoRotation.clockwise90Degrees),y.msZoom=!0,y.src=URL.createObjectURL(h),y.play(),document.body.appendChild(y),document.body.appendChild(w),y.addEventListener("click",A),w.addEventListener("click",function(){I(),o("Cancelled")},!1)},function(e){I(),o("Camera intitialization error "+e)})):(I(),o("Camera not found"))})},I=function(){y.pause(),y.src=null,[y,w].forEach(function(e){e&&document.body.removeChild(e)}),h&&(h.stopRecordAsync(),h=null)},A=function(){var n,r,s=Windows.Storage.CreationCollisionOption.generateUniqueName,d=Windows.Storage.ApplicationData.current.temporaryFolder;a==Camera.EncodingType.PNG?(r="photo.png",n=Windows.Media.MediaProperties.ImageEncodingProperties.createPng()):(r="photo.jpg",n=Windows.Media.MediaProperties.ImageEncodingProperties.createJpeg()),d.createFileAsync(r,s).done(function(a){h.capturePhotoToStorageFileAsync(n,a).done(function(){I();var n=function(n){c==Camera.DestinationType.FILE_URI||c==Camera.DestinationType.NATIVE_URI?i>0&&t>0?u(n):n.copyAsync(Windows.Storage.ApplicationData.current.localFolder,n.name,s).done(function(o){e("ms-appdata:///local/"+o.name)},o):i>0&&t>0?g(n):Windows.Storage.FileIO.readBufferAsync(n).done(function(o){var a=Windows.Security.Cryptography.CryptographicBuffer.encodeToBase64String(o);n.deleteAsync().done(function(){e(a)},function(o){console.error(o),e(a)})},o)};p?a.copyAsync(Windows.Storage.KnownFolders.picturesLibrary,a.name,s).done(function(){n(a)},o):n(a)},function(e){I(),o(e)})},function(e){I(),o(e)})};try{S(),W()}catch(F){o(F)}}}}},require("cordova/exec/proxy").add("Camera",module.exports);