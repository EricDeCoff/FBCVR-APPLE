function _hasId(e){return!e||e.indexOf(" ")>=0?!1:!0}function updateFromCordova(e,r){function t(e,r){r||(r="value");for(var t=[],o=0;o<e.length;o++)t.push(e[o][r]);return t}function o(e){for(var r=[],t=0;t<e.length;t++){var o={};for(var a in e[t])"formatted"!=a&&"id"!=a&&("type"==a?o[a]=[e[t][a]]:"country"==a?o.countryName=e[t][a]:o[a]=e[t][a]);r.push(o)}return r}function a(e){for(var r=[],t=0;t<e.length;t++){var o=e[t];if(o.value){var a={value:o.value};o.type&&(a.type=[o.type]),o.pref&&(a.pref=o.pref),r.push(a)}}return r}for(var i=[["givenName"],["familyName"],["honorificPrefix"],["honorificSuffix"],["middleName","additionalName"]],n=[["displayName","name"],["nickname"]],l=[],f=0;field=i[f++];)r.name[field[0]]&&(e[field[1]||field[0]]=r.name[field[0]].split(" "));for(f=0;field=n[f++];)r[field[0]]&&(e[field[1]||field[0]]=r[field[0]].split(" "));for(f=0;field=l[f++];)r[field[0]]&&(e[field[1]||field[0]]=r[field[0]]);if(r.birthday&&(e.bday=new Date(r.birthday)),r.emails){var s=a(r.emails);e.email=s}r.categories&&(e.category=t(r.categories)),r.addresses&&(e.adr=o(r.addresses)),r.phoneNumbers&&(e.tel=a(r.phoneNumbers)),r.organizations&&(e.org=t(r.organizations,"name"),e.jobTitle=t(r.organizations,"title")),r.note&&(e.note=[r.note])}function createMozillaFromCordova(e,r,t){var o;if(_hasId(t.id)){var a=navigator.mozContacts.find({filterBy:["id"],filterValue:t.id,filterOp:"equals"});return a.onsuccess=function(){o=a.result[0],updateFromCordova(o,t),e(o)},void(a.onerror=r)}o=new mozContact,updateFromCordova(o,t),e(o)}function createCordovaFromMozilla(e){var r=new Contact;return r.updateFromMozilla(e),r}function saveContacts(e,r,t){function o(r){return function(){var t=createCordovaFromMozilla(r);e(t)}}for(var a,i=0;a=t[i++];){createMozillaFromCordova(function(e){var t=navigator.mozContacts.save(e);t.onsuccess=o(e),t.onerror=r},function(){},a)}}function remove(e,r,t){for(var o=0,o=0;o<t.length;o++){if(!_hasId(t[o]))return console.error("FFOS: Attempt to remove unsaved contact"),void r(0);var a=navigator.mozContacts.find({filterBy:["id"],filterValue:t[o],filterOp:"equals"});a.onsuccess=function(){if(0===a.result.length)return console.error("FFOS: Attempt to remove a non existing contact"),void r(0);var t=a.result[0],o=navigator.mozContacts.remove(t);o.onsuccess=e,o.onerror=r},a.onerror=r}}function getMozSearchField(e){if(mozContactSearchFields.indexOf([e])>=0)return e;for(var r=0;r<mozContactSearchFields.length;r++)if(mozContactSearchFields[r].length>1&&mozContactSearchFields[r][1]===e)return mozContactSearchFields[r][0];return!1}function _getAll(e,r){var t=navigator.mozContacts.getAll({}),o=[];t.onsuccess=function(){t.result?(o.push(createCordovaFromMozilla(t.result)),t.continue()):e(o)},t.onerror=r}function search(e,r,t){var o=t[1]||{};if(!o.filter)return _getAll(e,r,t);for(var a=[],i=0;i<t[0].length;i++){var n=t[0][i],l=getMozSearchField(n);"name"!==n?"displayName"===n&&"init"in new mozContact?console.log("FFOS ContactProxy: Unable to search by displayName on FFOS 1.2"):l?a.push(l):console.log("FXOS ContactProxy: inallowed field passed to search filtered out: "+n):(a.push("givenName"),a.push("familyName"))}var f={filterBy:a,filterOp:"startsWith"};o.multiple||(f.filterLimit=1),f.filterValue=o.filter;var s=navigator.mozContacts.find(f);s.onsuccess=function(){for(var r=[],t=s.result,o=(t[0],0);o<t.length;o++)r.push(createCordovaFromMozilla(t[o]));e(r)},s.onerror=r}var Contact=require("./Contact"),ContactField=require("./ContactField"),ContactAddress=require("./ContactAddress"),ContactName=require("./ContactName");Contact.prototype.updateFromMozilla=function(e){function r(e){for(var r=[],t=0;t<e.length;t++){var o=e[t],a=new ContactField(o.type,o.value,o.pref);r.push(a)}return r}function t(e){for(var r=[],t=0;t<e.length;t++){var o=new ContactField(null,e[t]);r.push(o)}return r}function o(e){for(var r=[],t=0;t<e.length;t++){var o={};for(var a in e[t])"countryName"==a?o.country=e[t][a]:o[a]="type"==a?e[t][a].join(" "):e[t][a];r.push(o)}return r}function a(e,r){e=e?e:[],r=r?r:[];for(var t=Math.max(e.length,r.length),o=[],a=0;t>a;a++)o.push(new ContactOrganization(null,null,e[a]||null,null,r[a]||null));return o}function i(e){for(var r=["honorificPrefix","givenName","middleName","familyName","honorificSuffix"],t="",o=0;o<r.length;o++)e[r[o]]&&(t&&(t+=" "),t+=e[r[o]]);return t}e.id&&(this.id=e.id);for(var n=[["givenName"],["familyName"],["honorificPrefix"],["honorificSuffix"],["additionalName","middleName"]],l=[["name","displayName"],"nickname",["note"]],f=[],s=new ContactName,d=0;field=n[d++];)e[field[0]]&&(s[field[1]||field[0]]=e[field[0]].join(" "));for(this.name=s,d=0;field=l[d++];)e[field[0]]&&(this[field[1]||field[0]]=e[field[0]].join(" "));for(d=0;field=f[d++];)e[field[0]]&&(this[field[1]||field[0]]=e[field[0]]);e.email&&(this.emails=r(e.email)),e.category&&(this.categories=t(e.category)),e.adr&&(this.addresses=o(e.adr)),e.tel&&(this.phoneNumbers=r(e.tel)),e.bday&&(this.birthday=Date.parse(e.bday)),(e.org||e.jobTitle)&&(this.organizations=a(e.org,e.jobTitle)),this.name.formatted=i(this.name)};var mozContactSearchFields=[["name","displayName"],["givenName"],["familyName"],["email"],["tel"],["jobTitle"],["note"],["tel","phoneNumbers"],["email","emails"]];module.exports={save:saveContacts,remove:remove,search:search},require("cordova/exec/proxy").add("Contacts",module.exports);